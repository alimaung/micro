{% extends 'microapp/base.html' %}

{% block title %}Control Panel - Microfilm Processing System{% endblock %}

{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'microapp/css/control.css' %}">
{% endblock %}

{% block content %}
    <div class="control-container">
        <!-- Header Section -->
        <div class="control-header">
            <div class="header-content">
                <h1>System Control Panel</h1>
                <p class="subtitle">Monitor and control all aspects of the microfilm processing system</p>
            </div>
            <div class="connection-status">
                <div class="status-item">
                    <span class="status-indicator online">
                        <i class="fas fa-plug"></i>
                    </span>
                    <span class="status-label">System Online</span>
                </div>
                <div class="status-item">
                    <span class="ping-value">35ms</span>
                    <span class="status-label">Network Latency</span>
                </div>
            </div>
        </div>
        
        <!-- Primary Controls Card -->
        <div class="control-card primary-controls-card">
            <div class="card-header">
                <h2>Primary Controls</h2>
                <div class="header-actions">
                    <!-- Settings Icon for Relay Controls -->
                    <div class="settings-icon" id="settings-toggle">
                        <i class="fas fa-cog"></i>
                    </div>
                </div>
            </div>
            
            <!-- Main Control Buttons -->
            <div class="main-controls">
                <button id="mode-toggle" class="main-button">
                    <i id="mode-indicator" class="fas fa-sun"></i>
                    <span>Toggle Mode</span>
                </button>
                <button id="machine-switch" class="main-button">
                    <span id="machine-indicator" class="indicator"></span>
                    <span>Machine Power</span>
                </button>
                <button id="emergency-stop" class="main-button emergency">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Emergency Stop</span>
                </button>
            </div>
            
            <!-- Settings Section (Initially Hidden) -->
            <div class="settings-section" id="settings-section" style="display: none;">
                <h3>Connection Settings</h3>
                <div class="settings-grid">
                    <div class="settings-group">
                        <label for="com-port">Serial Port:</label>
                        <select id="com-port" class="styled-select">
                            {% for port in com_ports %}
                                <option value="{{ port }}">{{ port }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="settings-group">
                        <label for="baud-rate">Baud Rate:</label>
                        <select id="baud-rate" class="styled-select">
                            <option value="9600">9600</option>
                            <option value="19200">19200</option>
                            <option value="38400">38400</option>
                            <option value="57600">57600</option>
                            <option value="115200" selected>115200</option>
                        </select>
                    </div>
                    <div class="settings-group">
                        <label for="data-bits">Data Bits:</label>
                        <select id="data-bits" class="styled-select">
                            <option value="7">7</option>
                            <option value="8" selected>8</option>
                        </select>
                    </div>
                    <div class="settings-group">
                        <label for="parity">Parity:</label>
                        <select id="parity" class="styled-select">
                            <option value="none" selected>None</option>
                            <option value="even">Even</option>
                            <option value="odd">Odd</option>
                        </select>
                    </div>
                </div>
                <div class="connection-stats">
                    <div class="stat-item">
                        <span class="stat-label">Signal Quality:</span>
                        <span class="stat-value">98%</span>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 98%"></div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Transfer Rate:</span>
                        <span class="stat-value">11.2 KB/s</span>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 75%"></div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Packets Sent:</span>
                        <span class="stat-value">1,426</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Packets Received:</span>
                        <span class="stat-value">1,425</span>
                    </div>
                </div>
                <div class="settings-actions">
                    <button id="test-connection" class="action-button">
                        <i class="fas fa-link"></i>
                        Test Connection
                    </button>
                    <button id="save-settings" class="action-button primary">
                        <i class="fas fa-save"></i>
                        Save Settings
                    </button>
                </div>
            </div>
            
            <!-- Individual Relay Controls (Initially Hidden) -->
            <div class="relay-controls" id="relay-controls" style="display: none;">
                <h3>Relay Controls</h3>
                <div class="relay-grid">
                    {% for i in relays %}
                        <div class="relay-control">
                            <button class="relay-toggle" data-relay="{{ i }}">
                                <span class="relay-indicator" id="relay-indicator-{{ i }}"></span>
                                <span>Relay {{ i }}</span>
                            </button>
                        </div>
                    {% endfor %}
                </div>
                
                <div class="esp32-status">
                    <h3>ESP32 Controller Status</h3>
                    <div class="esp32-stats">
                        <div class="esp-stat-item">
                            <span class="esp-stat-icon">
                                <i class="fas fa-microchip"></i>
                            </span>
                            <div class="esp-stat-content">
                                <span class="esp-stat-value">82%</span>
                                <span class="esp-stat-label">CPU Load</span>
                                <div class="mini-progress-bar">
                                    <div class="mini-progress-fill" style="width: 82%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="esp-stat-item">
                            <span class="esp-stat-icon">
                                <i class="fas fa-thermometer-half"></i>
                            </span>
                            <div class="esp-stat-content">
                                <span class="esp-stat-value">42°C</span>
                                <span class="esp-stat-label">Temperature</span>
                                <div class="mini-progress-bar">
                                    <div class="mini-progress-fill" style="width: 42%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="esp-stat-item">
                            <span class="esp-stat-icon">
                                <i class="fas fa-memory"></i>
                            </span>
                            <div class="esp-stat-content">
                                <span class="esp-stat-value">124.6 KB</span>
                                <span class="esp-stat-label">Free Memory</span>
                                <div class="mini-progress-bar">
                                    <div class="mini-progress-fill" style="width: 63%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="esp-stat-item">
                            <span class="esp-stat-icon">
                                <i class="fas fa-clock"></i>
                            </span>
                            <div class="esp-stat-content">
                                <span class="esp-stat-value">12d 8h 43m</span>
                                <span class="esp-stat-label">Uptime</span>
                            </div>
                        </div>
                        <div class="esp-stat-item">
                            <span class="esp-stat-icon">
                                <i class="fas fa-wifi"></i>
                            </span>
                            <div class="esp-stat-content">
                                <span class="esp-stat-value">-58 dBm</span>
                                <span class="esp-stat-label">Signal Strength</span>
                                <div class="mini-progress-bar">
                                    <div class="mini-progress-fill" style="width: 75%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="esp-stat-item">
                            <span class="esp-stat-icon">
                                <i class="fas fa-battery-three-quarters"></i>
                            </span>
                            <div class="esp-stat-content">
                                <span class="esp-stat-value">3.8V</span>
                                <span class="esp-stat-label">Voltage</span>
                                <div class="mini-progress-bar">
                                    <div class="mini-progress-fill" style="width: 86%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Filming Machine Status Card -->
        <div class="control-card filming-machine-card">
            <div class="card-header">
                <h2>Filming Machine Status</h2>
                <div class="header-actions">
                    <span class="status-badge operational">
                        <i class="fas fa-check-circle"></i>
                        Operational
                    </span>
                </div>
            </div>
            
            <div class="machine-visual">
                <div class="machine-components">
                    <div class="component-item">
                        <div class="component-icon">
                            <i class="fas fa-camera"></i>
                        </div>
                        <div class="component-info">
                            <span class="component-name">Camera</span>
                            <span class="component-status">16mm / 8K</span>
                            <span class="status-dot online"></span>
                        </div>
                    </div>
                    <div class="component-item">
                        <div class="component-icon motor">
                            <i class="fas fa-cog fa-spin"></i>
                        </div>
                        <div class="component-info">
                            <span class="component-name">Shutter Motor</span>
                            <span class="component-status">Active / 180 RPM</span>
                            <span class="status-dot online"></span>
                        </div>
                    </div>
                    <div class="component-item">
                        <div class="component-icon motor">
                            <i class="fas fa-sync fa-spin"></i>
                        </div>
                        <div class="component-info">
                            <span class="component-name">Spool Motor</span>
                            <span class="component-status">Active / 60 RPM</span>
                            <span class="status-dot online"></span>
                        </div>
                    </div>
                    <div class="component-item">
                        <div class="component-icon vacuum">
                            <i class="fas fa-wind"></i>
                        </div>
                        <div class="component-info">
                            <span class="component-name">Vacuum Pump</span>
                            <span class="component-status">Active / 85%</span>
                            <span class="status-dot online"></span>
                        </div>
                    </div>
                    <div class="component-item">
                        <div class="component-icon">
                            <i class="fas fa-lightbulb"></i>
                        </div>
                        <div class="component-info">
                            <span class="component-name">Exposure Monitor</span>
                            <span class="component-status">Calibrated</span>
                            <span class="status-dot online"></span>
                        </div>
                    </div>
                </div>
                
                <div class="machine-charts">
                    <div class="chart-container chart-height-constrained">
                        <h3>Motor Performance</h3>
                        <canvas id="motors-chart" class="system-chart"></canvas>
                    </div>
                    <div class="chart-container chart-height-constrained">
                        <h3>System Temperature</h3>
                        <canvas id="temperature-chart" class="system-chart"></canvas>
                    </div>
                </div>
                
                <div class="machine-controls">
                    <button class="machine-control-button">
                        <i class="fas fa-sync"></i>
                        Recalibrate
                    </button>
                    <button class="machine-control-button">
                        <i class="fas fa-diagnostics"></i>
                        Diagnostics
                    </button>
                    <button class="machine-control-button">
                        <i class="fas fa-sliders-h"></i>
                        Adjust Settings
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Developer Machine Status Card -->
        <div class="control-card developer-machine-card">
            <div class="card-header">
                <h2>Developer Machine Status</h2>
                <div class="header-actions">
                    <span class="status-badge operational">
                        <i class="fas fa-check-circle"></i>
                        Operational
                    </span>
                </div>
            </div>
            
            <div class="developer-stats">
                <div class="dev-stat-panel">
                    <div class="dev-stat-item">
                        <span class="dev-stat-icon">
                            <i class="fas fa-thermometer-half"></i>
                        </span>
                        <div class="dev-stat-content">
                            <span class="dev-stat-value">37.8°C</span>
                            <span class="dev-stat-label">Temperature</span>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 75%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="dev-stat-item">
                        <span class="dev-stat-icon">
                            <i class="fas fa-tachometer-alt"></i>
                        </span>
                        <div class="dev-stat-content">
                            <span class="dev-stat-value">180 RPM</span>
                            <span class="dev-stat-label">Motor Speed</span>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 60%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="chemicals-level">
                    <h3>Chemical Levels</h3>
                    <div class="chemicals-grid">
                        <div class="chemical-container">
                            <div class="chemical-label">Developer</div>
                            <div class="level-indicator">
                                <div class="level-fill" style="height: 85%"></div>
                            </div>
                            <div class="chemical-percentage">85%</div>
                            <div class="chemical-date">Changed: 3 days ago</div>
                        </div>
                        <div class="chemical-container">
                            <div class="chemical-label">Fixer</div>
                            <div class="level-indicator">
                                <div class="level-fill" style="height: 72%"></div>
                            </div>
                            <div class="chemical-percentage">72%</div>
                            <div class="chemical-date">Changed: 3 days ago</div>
                        </div>
                        <div class="chemical-container">
                            <div class="chemical-label">Cleaner 1</div>
                            <div class="level-indicator">
                                <div class="level-fill" style="height: 93%"></div>
                            </div>
                            <div class="chemical-percentage">93%</div>
                            <div class="chemical-date">Changed: 3 days ago</div>
                        </div>
                        <div class="chemical-container">
                            <div class="chemical-label">Cleaner 2</div>
                            <div class="level-indicator">
                                <div class="level-fill" style="height: 65%"></div>
                            </div>
                            <div class="chemical-percentage">65%</div>
                            <div class="chemical-date">Changed: 3 days ago</div>
                        </div>
                    </div>
                </div>
                
                <div class="temperature-chart-container chart-height-constrained">
                    <h3>Temperature History (24h)</h3>
                    <canvas id="developer-temp-chart" class="system-chart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- External Systems Row -->
        <div class="external-systems-row">
            <!-- SMA Software Status Card -->
            <div class="control-card sma-status-card">
                <div class="card-header">
                    <h2>SMA Software</h2>
                    <div class="header-actions">
                        <span class="status-badge operational">
                            <i class="fas fa-check-circle"></i>
                            Running
                        </span>
                    </div>
                </div>
                
                <div class="sma-status">
                    <div class="status-metric">
                        <span class="metric-icon"><i class="fas fa-clock"></i></span>
                        <div class="metric-content">
                            <span class="metric-value">03:42:18</span>
                            <span class="metric-label">Uptime</span>
                        </div>
                    </div>
                    <div class="status-metric">
                        <span class="metric-icon"><i class="fas fa-film"></i></span>
                        <div class="metric-content">
                            <span class="metric-value">F-16-0001</span>
                            <span class="metric-label">Current Film</span>
                        </div>
                    </div>
                    <div class="status-metric">
                        <span class="metric-icon"><i class="fas fa-tasks"></i></span>
                        <div class="metric-content">
                            <span class="metric-value">127/423</span>
                            <span class="metric-label">Pages Processed</span>
                        </div>
                    </div>
                    <div class="status-metric">
                        <span class="metric-icon"><i class="fas fa-hourglass-half"></i></span>
                        <div class="metric-content">
                            <span class="metric-value">14:32:45</span>
                            <span class="metric-label">ETA</span>
                        </div>
                    </div>
                </div>
                
                <div class="software-actions">
                    <button class="soft-control-button">
                        <i class="fas fa-sync"></i>
                        Reconnect
                    </button>
                    <button class="soft-control-button">
                        <i class="fas fa-terminal"></i>
                        Console
                    </button>
                </div>
            </div>
            
            <!-- External PC Status Card -->
            <div class="control-card pc-status-card">
                <div class="card-header">
                    <h2>External PC</h2>
                    <div class="header-actions">
                        <span class="status-badge operational">
                            <i class="fas fa-check-circle"></i>
                            Connected
                        </span>
                    </div>
                </div>
                
                <div class="pc-status">
                    <div class="pc-resources">
                        <div class="resource-item">
                            <span class="resource-label">CPU Usage</span>
                            <div class="resource-bar">
                                <div class="resource-fill" style="width: 42%"></div>
                                <span class="resource-value">42%</span>
                            </div>
                        </div>
                        <div class="resource-item">
                            <span class="resource-label">Memory Usage</span>
                            <div class="resource-bar">
                                <div class="resource-fill" style="width: 68%"></div>
                                <span class="resource-value">68%</span>
                            </div>
                        </div>
                        <div class="resource-item">
                            <span class="resource-label">Disk Usage</span>
                            <div class="resource-bar">
                                <div class="resource-fill" style="width: 54%"></div>
                                <span class="resource-value">54%</span>
                            </div>
                        </div>
                        <div class="resource-item">
                            <span class="resource-label">Network Usage</span>
                            <div class="resource-bar">
                                <div class="resource-fill" style="width: 23%"></div>
                                <span class="resource-value">23%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="pc-info">
                        <div class="info-row">
                            <span class="info-label">Hostname:</span>
                            <span class="info-value">MICRO-PC01</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">IP Address:</span>
                            <span class="info-value">192.168.1.105</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Uptime:</span>
                            <span class="info-value">5d 12h 37m</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">OS:</span>
                            <span class="info-value">Windows 10 Pro</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        {% csrf_token %}
    </div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'microapp/js/control.js' %}"></script>
{% endblock %}