{% extends 'microapp/base.html' %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Analyze" %} - Microfilm Processing System{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'microapp/css/analyze/analyze.css' %}">
{% endblock %}

{% block content %}
<div class="analyze-container">
    <!-- Header Section -->
    <div class="analyze-header">
        <div class="header-content">
            <div class="header-text">
                <h1>{% trans "Project Analysis Dashboard" %}</h1>
                <p class="analyze-description">{% trans "Analyze registered projects and their data" %}</p>
            </div>
            <div class="header-stats">
                <div class="stat-card">
                    <div class="stat-number">{{ summary_stats.total_projects }}</div>
                    <div class="stat-label">{% trans "Projects" %}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{{ summary_stats.total_documents|floatformat:0 }}</div>
                    <div class="stat-label">{% trans "Documents" %}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{{ summary_stats.total_pages|floatformat:0 }}</div>
                    <div class="stat-label">{% trans "Pages" %}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{{ summary_stats.projects_with_oversized }}</div>
                    <div class="stat-label">{% trans "With Oversized" %}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="analyze-filters">
        <div class="filter-row">
            <div class="search-container">
                <form method="get" id="search-form">
                    <div class="search-input-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" name="search" placeholder="{% trans 'Search projects...' %}" 
                               value="{{ search_query }}" class="search-input">
                        <input type="hidden" name="status" value="{{ status_filter }}">
                    </div>
                </form>
            </div>
            <div class="filter-buttons">
                <div class="status-filters">
                    <a href="?status=registered&search={{ search_query }}" 
                       class="filter-btn {% if status_filter == 'registered' %}active{% endif %}">
                        {% trans "Registered Only" %}
                    </a>
                    <a href="?status=all&search={{ search_query }}" 
                       class="filter-btn {% if status_filter == 'all' %}active{% endif %}">
                        {% trans "All Projects" %}
                    </a>
                </div>
                <button class="refresh-btn" onclick="refreshAllData()">
                    <i class="fas fa-sync-alt"></i>
                    {% trans "Refresh" %}
                </button>
            </div>
        </div>
    </div>

    <!-- Projects Grid -->
    <div class="projects-grid">
        {% for item in page_obj %}
            {% with project=item.project data=item.data %}
            <div class="project-card" onclick="viewProjectDetail({{ project.id }})">
                <div class="project-card-header">
                    <div class="project-title">
                        <h3>{{ project.archive_id }}</h3>
                        <div class="project-meta">
                            <span class="location-badge location-{{ project.location|lower }}">{{ project.location }}</span>
                            {% if project.doc_type %}
                                <span class="doc-type-badge">{{ project.doc_type }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="project-status">
                        {% if project.processing_complete %}
                            <span class="status-badge status-completed">{% trans "Completed" %}</span>
                        {% elif project.film_allocation_complete %}
                            <span class="status-badge status-allocated">{% trans "Allocated" %}</span>
                        {% elif data.total_documents %}
                            <span class="status-badge status-analyzed">{% trans "Analyzed" %}</span>
                        {% else %}
                            <span class="status-badge status-registered">{% trans "Registered" %}</span>
                        {% endif %}
                    </div>
                </div>

                <div class="project-card-body">
                    <div class="key-metrics">
                        <div class="metric">
                            <i class="fas fa-file-alt metric-icon"></i>
                            <div class="metric-content">
                                <div class="metric-value">{{ data.total_documents|default:0|floatformat:0 }}</div>
                                <div class="metric-label">{% trans "Documents" %}</div>
                            </div>
                        </div>
                        <div class="metric">
                            <i class="fas fa-copy metric-icon"></i>
                            <div class="metric-content">
                                <div class="metric-value">{{ data.total_pages|default:0|floatformat:0 }}</div>
                                <div class="metric-label">{% trans "Pages" %}</div>
                            </div>
                        </div>
                        <div class="metric">
                            <i class="fas fa-film metric-icon"></i>
                            <div class="metric-content">
                                <div class="metric-value">{{ data.total_rolls|default:0 }}</div>
                                <div class="metric-label">{% trans "Rolls" %}</div>
                            </div>
                        </div>
                        <div class="metric">
                            <i class="fas fa-hdd metric-icon"></i>
                            <div class="metric-content">
                                <div class="metric-value">{{ data.total_size_formatted|default:"N/A" }}</div>
                                <div class="metric-label">{% trans "Size" %}</div>
                            </div>
                        </div>
                    </div>

                    {% if data.has_oversized %}
                    <div class="oversized-alert">
                        <i class="fas fa-exclamation-triangle"></i>
                        {% trans "Contains oversized documents" %} ({{ data.oversized_count }})
                    </div>
                    {% endif %}

                    {% if data.temp_rolls %}
                    <div class="temp-rolls-info">
                        <i class="fas fa-clock"></i>
                        {% trans "Temp rolls" %}: {{ data.temp_rolls }}
                    </div>
                    {% endif %}
                </div>

                <div class="project-card-footer">
                    <div class="project-dates">
                        <div class="date-info">
                            <small>{% trans "Created" %}: {{ project.created_at|date:"M d, Y" }}</small>
                        </div>
                        <div class="date-info">
                            <small>{% trans "Updated" %}: {{ project.updated_at|date:"M d, Y" }}</small>
                        </div>
                    </div>
                    <div class="project-actions">
                        <button class="action-btn" onclick="event.stopPropagation(); exportProjectData({{ project.id }})">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="action-btn" onclick="event.stopPropagation(); refreshProjectData({{ project.id }})">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
            {% endwith %}
        {% empty %}
            <div class="no-projects">
                <div class="no-projects-content">
                    <i class="fas fa-chart-bar no-projects-icon"></i>
                    <h3>{% trans "No Projects Found" %}</h3>
                    <p>{% trans "No projects with analysis data found. Try adjusting your filters or check that projects have been analyzed." %}</p>
                    <a href="{% url 'register' %}" class="btn btn-primary">
                        <i class="fas fa-plus"></i>
                        {% trans "Register New Project" %}
                    </a>
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <div class="pagination-container">
        <div class="pagination">
            {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}&search={{ search_query }}&status={{ status_filter }}" 
                   class="page-link">
                    <i class="fas fa-chevron-left"></i>
                </a>
            {% endif %}
            
            {% for page_num in page_obj.paginator.page_range %}
                {% if page_num == page_obj.number %}
                    <span class="page-link current">{{ page_num }}</span>
                {% else %}
                    <a href="?page={{ page_num }}&search={{ search_query }}&status={{ status_filter }}" 
                       class="page-link">{{ page_num }}</a>
                {% endif %}
            {% endfor %}
            
            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}&search={{ search_query }}&status={{ status_filter }}" 
                   class="page-link">
                    <i class="fas fa-chevron-right"></i>
                </a>
            {% endif %}
        </div>
        
        <div class="pagination-info">
            {% trans "Showing" %} {{ page_obj.start_index }} - {{ page_obj.end_index }} 
            {% trans "of" %} {{ page_obj.paginator.count }} {% trans "projects" %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Loading Modal -->
<div id="loading-modal" class="modal">
    <div class="modal-content">
        <div class="loading-spinner"></div>
        <p>{% trans "Loading project data..." %}</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    <script src="{% static 'microapp/js/analyze/analyze.js' %}"></script>
{% endblock %} 