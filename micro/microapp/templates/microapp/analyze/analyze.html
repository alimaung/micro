{% extends 'microapp/base.html' %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Analyze" %} - Microfilm Processing System{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'microapp/css/analyze/analyze.css' %}">
{% endblock %}

{% block content %}
<div class="analyze-container">
    <!-- Header Section -->
    <div class="analyze-header">
        <div class="header-content">
            <div class="header-text">
                <h1>{% trans "Project Analysis Dashboard" %}</h1>
                <p class="analyze-description">{% trans "Discover, analyze, and register projects" %}</p>
            </div>
            <div class="header-stats">
                <div class="stat-card">
                    <div class="stat-number">{{ summary_stats.total_unanalyzed }}</div>
                    <div class="stat-label">{% trans "Unanalyzed" %}</div>
                    <div class="stat-details">
                        <small>{{ summary_stats.unanalyzed_total_pdfs }} PDFs • {{ summary_stats.unanalyzed_total_excel }} Excel • {{ summary_stats.unanalyzed_total_size_formatted }}</small>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{{ summary_stats.total_analyzed }}</div>
                    <div class="stat-label">{% trans "Analyzed" %}</div>
                    <div class="stat-details">
                        <small>{{ summary_stats.analyzed_total_16mm }} × 16mm • {{ summary_stats.analyzed_total_35mm }} × 35mm • {{ summary_stats.analyzed_avg_utilization }}% util • {{ summary_stats.analyzed_temp_rolls_created|add:summary_stats.analyzed_temp_rolls_used }} temp</small>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{{ summary_stats.total_registered }}</div>
                    <div class="stat-label">{% trans "Registered" %}</div>
                    <div class="stat-details">
                        <small>{{ summary_stats.registered_total_rolls }} rolls • {% if summary_stats.registered_total_size_formatted and summary_stats.registered_total_size_formatted != "0 B" %}{{ summary_stats.registered_total_size_formatted }}{% else %}Size N/A{% endif %}</small>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{{ summary_stats.analyzed_total_documents|add:summary_stats.registered_total_documents|floatformat:0 }}</div>
                    <div class="stat-label">{% trans "Total Documents" %}</div>
                    <div class="stat-details">
                        <small>{{ summary_stats.analyzed_total_pages|add:summary_stats.registered_total_pages|floatformat:0 }} pages • {{ summary_stats.analyzed_total_oversized }} oversized</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section Navigation -->
    <div class="section-navigation">
        <div class="section-tabs">
            <button class="section-tab {% if section_filter == 'all' %}active{% endif %}" 
                    onclick="switchSection('all')">
                <i class="fas fa-th-large"></i>
                {% trans "All" %}
            </button>
            <button class="section-tab {% if section_filter == 'unanalyzed' %}active{% endif %}" 
                    onclick="switchSection('unanalyzed')">
                <i class="fas fa-folder-open"></i>
                {% trans "Unanalyzed" %} ({{ summary_stats.total_unanalyzed }})
            </button>
            <button class="section-tab {% if section_filter == 'analyzed' %}active{% endif %}" 
                    onclick="switchSection('analyzed')">
                <i class="fas fa-chart-line"></i>
                {% trans "Analyzed" %} ({{ summary_stats.total_analyzed }})
            </button>
            <button class="section-tab {% if section_filter == 'registered' %}active{% endif %}" 
                    onclick="switchSection('registered')">
                <i class="fas fa-check-circle"></i>
                {% trans "Registered" %} ({{ summary_stats.total_registered }})
            </button>
        </div>
        
        <!-- Search and Filters -->
        <div class="controls-container">
            <div class="search-container">
                <form method="get" id="search-form">
                    <div class="search-input-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" name="search" placeholder="{% trans 'Search folders and projects...' %}" 
                               value="{{ search_query }}" class="search-input">
                        <input type="hidden" name="section" value="{{ section_filter }}">
                    </div>
                </form>
            </div>
            <!-- View toggle and sort controls will be dynamically added here by JavaScript -->
        </div>
    </div>

    <!-- Content Sections -->
    {% if section_filter == 'all' or section_filter == 'unanalyzed' %}
    {% if sections_data.unanalyzed %}
    <div class="section-container unanalyzed-section">
        <div class="section-header">
            <h2><i class="fas fa-folder-open"></i> {% trans "Unanalyzed Folders" %}</h2>
            <p class="section-description">{% trans "Folders that haven't been analyzed yet - unknown content" %}</p>
        </div>
        
        <div class="cards-grid">
            {% for folder in sections_data.unanalyzed %}
            <div class="folder-card unanalyzed">
                <div class="card-header">
                    <div class="card-title">
                        <h3>{{ folder.folder_name }}</h3>
                        <div class="card-meta">
                            <span class="status-badge status-unanalyzed">{% trans "Unanalyzed" %}</span>
                        </div>
                    </div>
                </div>

                <div class="card-body">
                    <div class="folder-path">
                        <i class="fas fa-folder-open"></i>
                        <span title="{{ folder.folder_path }}">{{ folder.folder_path|truncatechars:50 }}</span>
                    </div>
                    
                    <div class="key-metrics">
                        <div class="metric">
                            <i class="fas fa-file metric-icon"></i>
                            <div class="metric-content">
                                <div class="metric-value">{{ folder.file_count }}</div>
                                <div class="metric-label">{% trans "Total Files" %}</div>
                            </div>
                        </div>
                        <div class="metric">
                            <i class="fas fa-file-pdf metric-icon"></i>
                            <div class="metric-content">
                                <div class="metric-value">{{ folder.pdf_count }}</div>
                                <div class="metric-label">{% trans "PDFs" %}</div>
                            </div>
                        </div>
                        <div class="metric">
                            <i class="fas fa-file-excel metric-icon"></i>
                            <div class="metric-content">
                                <div class="metric-value">{{ folder.excel_count|default:0 }}</div>
                                <div class="metric-label">{% trans "Excel" %}</div>
                            </div>
                        </div>
                        <div class="metric">
                            <i class="fas fa-file-alt metric-icon"></i>
                            <div class="metric-content">
                                <div class="metric-value">{{ folder.other_count|default:0 }}</div>
                                <div class="metric-label">{% trans "Others" %}</div>
                            </div>
                        </div>
                        <div class="metric">
                            <i class="fas fa-hdd metric-icon"></i>
                            <div class="metric-content">
                                <div class="metric-value">{{ folder.total_size_formatted }}</div>
                                <div class="metric-label">{% trans "Size" %}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-footer">
                    <div class="card-actions">
                        <button class="btn btn-primary" 
                                onclick="showAnalyzeModal('{{ folder.folder_path|escapejs }}', '{{ folder.folder_name|escapejs }}')">
                            <i class="fas fa-chart-line"></i>
                            {% trans "Analyze" %}
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    {% endif %}

    {% if section_filter == 'all' or section_filter == 'analyzed' %}
    {% if sections_data.analyzed %}
    <div class="section-container analyzed-section">
        <div class="section-header">
            <h2><i class="fas fa-chart-line"></i> {% trans "Analyzed Folders" %}</h2>
            <p class="section-description">{% trans "Folders that have been analyzed but not yet registered" %}</p>
        </div>
        
        <div class="cards-grid">
            {% for folder in sections_data.analyzed %}
            <div class="folder-card analyzed">
                <div class="card-header">
                    <div class="card-title">
                        <h3>{{ folder.folder_name }}</h3>
                        <div class="card-meta">
                            <span class="status-badge status-analyzed">{% trans "Analyzed" %}</span>
                            {% if folder.recommended_workflow != 'unknown' %}
                                <span class="workflow-badge">{{ folder.recommended_workflow|title }}</span>
                            {% endif %}
                            
                            <!-- Film Type Badges -->
                            {% if folder.estimated_rolls_16mm > 0 and folder.estimated_rolls_35mm > 0 %}
                                <span class="film-type-badge film-16mm">16mm</span>
                                <span class="film-type-badge film-35mm">35mm</span>
                            {% elif folder.estimated_rolls_35mm > 0 %}
                                <span class="film-type-badge film-35mm">35mm</span>
                            {% elif folder.estimated_rolls_16mm > 0 %}
                                <span class="film-type-badge film-16mm">16mm</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="card-body">
                    <div class="folder-path">
                        <i class="fas fa-folder-open"></i>
                        <span title="{{ folder.folder_path }}">{{ folder.folder_path|truncatechars:50 }}</span>
                    </div>
                    
                    <div class="key-metrics">
                        <div class="metric">
                            <i class="fas fa-file-alt metric-icon"></i>
                            <div class="metric-content">
                                <div class="metric-value">{{ folder.total_documents }}</div>
                                <div class="metric-label">{% trans "Documents" %}</div>
                            </div>
                        </div>
                        <div class="metric">
                            <i class="fas fa-copy metric-icon"></i>
                            <div class="metric-content">
                                <div class="metric-value">{{ folder.total_pages }}</div>
                                <div class="metric-label">{% trans "Pages" %}</div>
                            </div>
                        </div>
                        
                        <!-- Film Roll Metrics -->
                        {% if folder.estimated_rolls_16mm > 0 and folder.estimated_rolls_35mm > 0 %}
                            <!-- Show both 16mm and 35mm -->
                            <div class="metric metric-film">
                                <i class="fas fa-film metric-icon film-16mm-icon"></i>
                                <div class="metric-content">
                                    <div class="metric-value">{{ folder.estimated_rolls_16mm }}</div>
                                    <div class="metric-label">{% trans "16mm Rolls" %}</div>
                                </div>
                            </div>
                            <div class="metric metric-film">
                                <i class="fas fa-film metric-icon film-35mm-icon"></i>
                                <div class="metric-content">
                                    <div class="metric-value">{{ folder.estimated_rolls_35mm }}</div>
                                    <div class="metric-label">{% trans "35mm Rolls" %}</div>
                                </div>
                            </div>
                        {% elif folder.estimated_rolls_35mm > 0 %}
                            <!-- Show only 35mm -->
                            <div class="metric metric-film">
                                <i class="fas fa-film metric-icon film-35mm-icon"></i>
                                <div class="metric-content">
                                    <div class="metric-value">{{ folder.estimated_rolls_35mm }}</div>
                                    <div class="metric-label">{% trans "35mm Rolls" %}</div>
                                </div>
                            </div>
                        {% elif folder.estimated_rolls_16mm > 0 %}
                            <!-- Show only 16mm -->
                            <div class="metric metric-film">
                                <i class="fas fa-film metric-icon film-16mm-icon"></i>
                                <div class="metric-content">
                                    <div class="metric-value">{{ folder.estimated_rolls_16mm }}</div>
                                    <div class="metric-label">{% trans "16mm Rolls" %}</div>
                                </div>
                            </div>
                        {% else %}
                            <!-- Fallback to total rolls -->
                            <div class="metric">
                                <i class="fas fa-film metric-icon"></i>
                                <div class="metric-content">
                                    <div class="metric-value">{{ folder.estimated_rolls }}</div>
                                    <div class="metric-label">{% trans "Est. Rolls" %}</div>
                                </div>
                            </div>
                        {% endif %}
                        
                        <!-- Always show oversized count -->
                        <div class="metric metric-oversized">
                            <i class="fas fa-exclamation-triangle metric-icon {% if folder.has_oversized %}oversized-icon{% endif %}"></i>
                            <div class="metric-content">
                                <div class="metric-value {% if folder.has_oversized %}oversized-value{% endif %}">{{ folder.oversized_count|default:0 }}</div>
                                <div class="metric-label">{% trans "Oversized" %}</div>
                            </div>
                        </div>
                        
                        <!-- Temp Roll Metrics -->
                        {% if folder.estimated_temp_rolls_created > 0 or folder.estimated_temp_rolls_used > 0 %}
                        <div class="metric metric-temp-rolls">
                            <i class="fas fa-recycle metric-icon"></i>
                            <div class="metric-content">
                                <div class="metric-value">
                                    {% if folder.estimated_temp_rolls_created > 0 and folder.estimated_temp_rolls_used > 0 %}
                                        {{ folder.estimated_temp_rolls_created }}+{{ folder.estimated_temp_rolls_used }}
                                    {% elif folder.estimated_temp_rolls_created > 0 %}
                                        +{{ folder.estimated_temp_rolls_created }}
                                    {% else %}
                                        {{ folder.estimated_temp_rolls_used }}
                                    {% endif %}
                                </div>
                                <div class="metric-label">{% trans "Temp Rolls" %}</div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="metric">
                            <i class="fas fa-hdd metric-icon"></i>
                            <div class="metric-content">
                                <div class="metric-value">{{ folder.total_size_formatted }}</div>
                                <div class="metric-label">{% trans "Size" %}</div>
                            </div>
                        </div>
                    </div>

                    {% if folder.has_oversized %}
                    <div class="oversized-alert">
                        <i class="fas fa-exclamation-triangle"></i>
                        {% trans "Contains oversized documents" %} ({{ folder.oversized_count }})
                    </div>
                    {% endif %}

                    {% if folder.pdf_folder_found %}
                    <div class="pdf-folder-info">
                        <i class="fas fa-check-circle"></i>
                        {% trans "PDF folder found" %}
                    </div>
                    {% endif %}
                    
                    <!-- Utilization Progress Bar -->
                    {% if folder.overall_utilization > 0 %}
                    <div class="utilization-container">
                        <div class="utilization-header">
                            <span class="utilization-label">{% trans "Roll Utilization" %}</span>
                            <span class="utilization-percentage">{{ folder.overall_utilization }}%</span>
                        </div>
                        <div class="utilization-bar">
                            <div class="utilization-fill" style="width: {{ folder.overall_utilization }}%"></div>
                        </div>
                        <div class="utilization-description">
                            {% if folder.overall_utilization >= 85 %}
                                <small class="utilization-excellent">{% trans "Excellent efficiency" %}</small>
                            {% elif folder.overall_utilization >= 70 %}
                                <small class="utilization-good">{% trans "Good efficiency" %}</small>
                            {% elif folder.overall_utilization >= 50 %}
                                <small class="utilization-fair">{% trans "Fair efficiency" %}</small>
                            {% else %}
                                <small class="utilization-poor">{% trans "Low efficiency" %}</small>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>

                <div class="card-footer">
                    <div class="analysis-info">
                        <small>{% trans "Analyzed" %}: {{ folder.analyzed_at|date:"M d, Y H:i" }}</small>
                        <small>{% trans "By" %}: {{ folder.analyzed_by.username }}</small>
                    </div>
                    <div class="card-actions">
                        <button class="btn btn-secondary" 
                                onclick="showAnalyzeModal('{{ folder.folder_path|escapejs }}', '{{ folder.folder_name|escapejs }}')">
                            <i class="fas fa-sync-alt"></i>
                            {% trans "Re-analyze" %}
                        </button>
                        <button class="btn btn-primary" 
                                onclick="showRegistrationModal({{ folder.id }}, '{{ folder.folder_name|escapejs }}')">
                            <i class="fas fa-plus-circle"></i>
                            {% trans "Register" %}
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    {% endif %}

    {% if section_filter == 'all' or section_filter == 'registered' %}
    {% if sections_data.registered %}
    <div class="section-container registered-section">
        <div class="section-header">
            <h2><i class="fas fa-check-circle"></i> {% trans "Registered Projects" %}</h2>
            <p class="section-description">{% trans "Projects that have been registered and are in the workflow" %}</p>
        </div>
        
        <div class="cards-grid">
            {% for item in sections_data.registered %}
            {% with project=item.project data=item.data %}
            <div class="project-card registered" onclick="viewProjectDetail({{ project.id }})">
                <div class="card-header">
                    <div class="card-title">
                        <h3>{{ project.archive_id }}</h3>
                        <div class="card-meta">
                            <span class="location-badge location-{{ project.location|lower }}">{{ project.location }}</span>
                            {% if project.doc_type %}
                                <span class="doc-type-badge">{{ project.doc_type }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-status">
                        {% if project.processing_complete %}
                            <span class="status-badge status-completed">{% trans "Completed" %}</span>
                        {% elif project.film_allocation_complete %}
                            <span class="status-badge status-allocated">{% trans "Allocated" %}</span>
                        {% elif data.total_documents %}
                            <span class="status-badge status-analyzed">{% trans "Analyzed" %}</span>
                        {% else %}
                            <span class="status-badge status-registered">{% trans "Registered" %}</span>
                        {% endif %}
                    </div>
                </div>

                <div class="card-body">
                    <div class="key-metrics">
                        <div class="metric">
                            <i class="fas fa-file-alt metric-icon"></i>
                            <div class="metric-content">
                                <div class="metric-value">{{ data.total_documents|default:0|floatformat:0 }}</div>
                                <div class="metric-label">{% trans "Documents" %}</div>
                            </div>
                        </div>
                        <div class="metric">
                            <i class="fas fa-copy metric-icon"></i>
                            <div class="metric-content">
                                <div class="metric-value">{{ data.total_pages|default:0|floatformat:0 }}</div>
                                <div class="metric-label">{% trans "Pages" %}</div>
                            </div>
                        </div>
                        <div class="metric">
                            <i class="fas fa-film metric-icon"></i>
                            <div class="metric-content">
                                <div class="metric-value">{{ data.total_rolls|default:0 }}</div>
                                <div class="metric-label">{% trans "Rolls" %}</div>
                            </div>
                        </div>
                        <div class="metric">
                            <i class="fas fa-hdd metric-icon"></i>
                            <div class="metric-content">
                                <div class="metric-value">{% if data.total_size_formatted and data.total_size_formatted != "0 B" %}{{ data.total_size_formatted }}{% else %}N/A{% endif %}</div>
                                <div class="metric-label">{% trans "Size" %}</div>
                            </div>
                        </div>
                        
                        <!-- Temp Roll Metrics for Registered Projects -->
                        {% if data.temp_rolls_created > 0 or data.temp_rolls_used > 0 %}
                        <div class="metric metric-temp-rolls">
                            <i class="fas fa-recycle metric-icon"></i>
                            <div class="metric-content">
                                <div class="metric-value">
                                    {% if data.temp_rolls_created > 0 and data.temp_rolls_used > 0 %}
                                        {{ data.temp_rolls_created }}+{{ data.temp_rolls_used }}
                                    {% elif data.temp_rolls_created > 0 %}
                                        +{{ data.temp_rolls_created }}
                                    {% else %}
                                        {{ data.temp_rolls_used }}
                                    {% endif %}
                                </div>
                                <div class="metric-label">{% trans "Temp Rolls" %}</div>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    {% if data.has_oversized %}
                    <div class="oversized-alert">
                        <i class="fas fa-exclamation-triangle"></i>
                        {% trans "Contains oversized documents" %} ({{ data.oversized_count }})
                    </div>
                    {% endif %}
                </div>

                <div class="card-footer">
                    <div class="project-dates">
                        <small>{% trans "Created" %}: {{ project.created_at|date:"M d, Y" }}</small>
                        <small>{% trans "Updated" %}: {{ project.updated_at|date:"M d, Y" }}</small>
                    </div>
                    <div class="card-actions">
                        <button class="action-btn" onclick="event.stopPropagation(); exportProjectData({{ project.id }})">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="action-btn" onclick="event.stopPropagation(); refreshProjectData({{ project.id }})">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
            {% endwith %}
            {% endfor %}
        </div>
    </div>
    {% endif %}
    {% endif %}

    <!-- Empty State -->
    {% if not sections_data.unregistered and not sections_data.analyzed and not sections_data.registered %}
    <div class="empty-state">
        <div class="empty-state-content">
            <i class="fas fa-search empty-state-icon"></i>
            <h3>{% trans "No Items Found" %}</h3>
            <p>{% trans "No folders or projects found matching your criteria." %}</p>
            <div class="empty-state-actions">
                <button class="btn btn-primary" onclick="switchSection('all')">
                    <i class="fas fa-eye"></i>
                    {% trans "View All" %}
                </button>
                <a href="{% url 'register' %}" class="btn btn-secondary">
                    <i class="fas fa-plus"></i>
                    {% trans "Register New Project" %}
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <div class="pagination-container">
        <div class="pagination">
            {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}&search={{ search_query }}&section={{ section_filter }}" 
                   class="page-link">
                    <i class="fas fa-chevron-left"></i>
                </a>
            {% endif %}
            
            {% for page_num in page_obj.paginator.page_range %}
                {% if page_num == page_obj.number %}
                    <span class="page-link current">{{ page_num }}</span>
                {% else %}
                    <a href="?page={{ page_num }}&search={{ search_query }}&section={{ section_filter }}" 
                       class="page-link">{{ page_num }}</a>
                {% endif %}
            {% endfor %}
            
            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}&search={{ search_query }}&section={{ section_filter }}" 
                   class="page-link">
                    <i class="fas fa-chevron-right"></i>
                </a>
            {% endif %}
        </div>
        
        <div class="pagination-info">
            {% trans "Showing" %} {{ page_obj.start_index }} - {{ page_obj.end_index }} 
            {% trans "of" %} {{ page_obj.paginator.count }} {% trans "items" %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Loading Modal -->
<div id="loading-modal" class="modal">
    <div class="modal-content">
        <div class="loading-spinner"></div>
        <p>{% trans "Processing..." %}</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    <script src="{% static 'microapp/js/analyze/analyze.js' %}"></script>
{% endblock %} 