<div class="container mt-4">
    <h1 class="mb-4">Film Number Allocation Testing</h1>
    
    <!-- Project Information -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h2 class="h5 mb-0">Project Information</h2>
        </div>
        <div class="card-body">
            <div class="project-info">
                <p><strong>Project ID:</strong> <span id="projectIdDisplay">Loading...</span></p>
                <p><strong>Archive ID:</strong> <span id="archiveIdDisplay">Loading...</span></p>
                <p><strong>Project Name:</strong> <span id="projectNameDisplay">Loading...</span></p>
            </div>
        </div>
    </div>
    
    <!-- Data Preview -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h2 class="h5 mb-0">LocalStorage Data Preview</h2>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h3 class="h6">Project Data</h3>
                    <pre id="projectDataPreview" class="data-preview">No data available</pre>
                </div>
                <div class="col-md-6">
                    <h3 class="h6">Analysis Data</h3>
                    <pre id="analysisDataPreview" class="data-preview">No data available</pre>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-6">
                    <h3 class="h6">Allocation Data</h3>
                    <pre id="allocationDataPreview" class="data-preview">No data available</pre>
                </div>
                <div class="col-md-6">
                    <h3 class="h6">Index Data</h3>
                    <pre id="indexDataPreview" class="data-preview">No data available</pre>
                </div>
            </div>
            <div class="mt-3">
                <button id="clearDataBtn" class="btn btn-warning">Clear Data</button>
            </div>
        </div>
    </div>
    
    <!-- Allocation Controls -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h2 class="h5 mb-0">Film Number Allocation</h2>
        </div>
        <div class="card-body">
            <div id="errorContainer" class="alert alert-danger" style="display: none;"></div>
            <button id="allocateBtn" class="btn btn-primary">Start Film Number Allocation</button>
            
            <!-- Progress Panel -->
            <div id="progressPanel" class="mt-3" style="display: none;">
                <h3 class="h6">Allocation Progress</h3>
                <div class="progress">
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" 
                         style="width: 0%">0%</div>
                </div>
                <p id="statusMessage" class="mt-2">Preparing to allocate film numbers...</p>
            </div>
        </div>
    </div>
    
    <!-- Results Section -->
    <div id="resultsSection" class="card mb-4" style="display: none;">
        <div class="card-header bg-success text-white">
            <h2 class="h5 mb-0">Allocation Results</h2>
        </div>
        <div class="card-body">
            <pre id="resultsPreview" class="data-preview">No results available</pre>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get project ID from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const urlProjectId = urlParams.get('id');
        
        // Initialize with project ID from URL or localStorage
        if (urlProjectId) {
            initFilmNumberAllocation(parseInt(urlProjectId));
        } else {
            // Fallback to localStorage
            const projectData = JSON.parse(localStorage.getItem('microfilmProjectState') || '{}');
            if (projectData.projectId) {
                initFilmNumberAllocation(projectData.projectId);
            } else {
                showError('No project ID found in URL or localStorage');
            }
        }
        
        // Initialize data display
        loadAndDisplayData();
    });
</script>
{% endblock %}