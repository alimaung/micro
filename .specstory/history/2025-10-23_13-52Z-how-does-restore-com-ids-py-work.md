<!-- Generated by SpecStory, Markdown v2.0.0 -->

<!-- cursor Session 86c76e88-6950-4945-9342-7e8c496ec089 (2025-10-23 13:52Z) -->

# How does restore_com_ids.py work? (2025-10-23 13:52Z)

_**User (2025-10-21 07:41Z)**_

@restore_com_ids.py how does it restore the com ids?



---

_**Agent (model claude-4-sonnet, mode Agent)**_

I'll analyze the `restore_com_ids.py` file to explain how it restores COM IDs. Let me examine the code structure and flow.

---

<tool-use data-tool-type="search" data-tool-name="codebase_search">
<details>
                <summary>Tool use: **codebase_search** • Searched codebase "How are COM IDs stored and used in the Document model?" • **13** results</summary>
            
| File | Lines |
|------|-------|
| `micro/microapp/models.py` | L11-135 |
| `micro/microapp/models.py` | L274-348 |
| `micro/microapp/models.py` | L516-648 |
| `micro/microapp/models.py` | L6-85 |
| `micro/microapp/models.py` | L338-373 |
| `micro/microapp/models.py` | L1311-1478 |
| `micro/microapp/models.py` | L87-147 |
| `micro/microapp/models.py` | L123-158 |
| `micro/microapp/services/handoff_service.py` | L154-1922 |
| `micro/microapp/services/film_number_manager.py` | L39-1580 |
| `micro/microapp/views/handoff_views.py` | L330-485 |
| `micro/microapp/views/handoff_views.py` | L244-330 |
| `micro/microapp/models.py` | L9-121 |

</details>
</tool-use>

---

Now let me examine how the COM ID restoration process works by analyzing the key functions:

Based on my analysis of the `restore_com_ids.py` file, here's how it restores COM IDs:

## Overview

The `restore_com_ids` command is a Django management command that reads COM ID mappings from Excel files (comlist files) and updates Document records in the database with missing COM IDs.

## How It Works

### 1. **Project Selection**
The command can process projects in three ways:
- **Specific project**: `--project-id 123` processes only that project
- **Batch mode**: `--batch` finds all projects with missing COM IDs that have a `comlist_path` set
- **All projects**: Default behavior processes all projects with a `comlist_path`

### 2. **Excel File Processing**
For each project, it reads the comlist Excel file (`.xls` or `.xlsx`) from the `project.comlist_path`:

```python
# The Excel file contains two columns:
# Column 0: Barcode (16-digit document identifier)  
# Column 1: COM ID (8-digit identifier)
```

### 3. **Data Validation & Normalization**

**Barcode Validation** (`validate_barcode`):
- Expects exactly 16 digits
- Strips whitespace and extracts digits
- Falls back to original format for backward compatibility

**COM ID Validation** (`validate_com_id`):
- Expects exactly 8 digits
- Handles different input types (int, float, string)
- Pads shorter IDs with leading zeros (e.g., "123" becomes "00000123")

### 4. **Document Matching Process**

For each Document in the project:

1. **Normalize the document ID**: Remove `.pdf` extension
2. **Validate as barcode**: Check if it's a valid 16-digit barcode
3. **Lookup COM ID**: Search the Excel mappings using multiple strategies:
   - Primary: Use validated barcode
   - Fallback 1: Use normalized document ID
   - Fallback 2: Try numeric conversion for backward compatibility

### 5. **Update Logic**

```python
# Only updates if:
# - Document has no COM ID (com_id is None/empty), OR
# - --force flag is used to overwrite existing COM IDs

if not self.force and document.com_id is not None:
    continue  # Skip if already has COM ID

# Validate COM ID from Excel before storing
com_id_valid, validated_com_id = validate_com_id(com_id)
if com_id_valid:
    document.com_id = validated_com_id
    document.save()
```

### 6. **Key Features**

- **Dry Run Mode**: `--dry-run` shows what would be updated without saving
- **Force Mode**: `--force` overwrites existing COM IDs
- **Verbose Output**: `--verbose` shows detailed processing information
- **Error Handling**: Continues processing even if individual documents fail
- **Backward Compatibility**: Multiple lookup strategies for different barcode formats

### 7. **Data Flow Example**

```
Excel File:     Document in DB:        Result:
1234567890123456 → doc_id: "1234567890123456.pdf" → com_id: "12345678"
12345678         → com_id: None
```

The command essentially bridges the gap between the Excel comlist files (which contain the official COM ID mappings) and the Document records in the database that may have been created without these COM IDs during initial processing.

This is particularly useful when:
- Documents were imported before COM IDs were available
- The initial processing missed some COM ID mappings
- COM IDs need to be updated with corrected values

---

_**User (2025-10-21 07:41Z)**_

does this chekout

---

_**Agent (model claude-4-sonnet, mode Agent)**_

Looking at the terminal output, **yes, this checks out perfectly!** The dry run results confirm exactly how the COM ID restoration process works:

## What the Output Shows

1. **Initial Analysis**: The first command showed 24 projects with missing COM IDs totaling 8,201 documents without COM IDs

2. **Dry Run Results**: The `restore_com_ids --dry-run` command found it could restore COM IDs for most of those missing documents:
   - **Successfully matched**: ~7,396 COM IDs (adding up the "Updated X COM IDs" numbers)
   - **Could not match**: ~805 COM IDs (the difference)

## Key Observations

### ✅ **Perfect Matches**
Many projects show exact matches between missing COM IDs and what can be restored:
- `RRD002-2025`: 230 missing → 230 can be updated
- `RRD042-2025`: 36 missing → 36 can be updated  
- `RRD021-2024`: 1155 missing → 1155 can be updated

### ⚠️ **Partial Matches**
Some projects show partial matches, indicating some documents in the Excel file don't match database records:
- `XRRD002-2025` (ID: 114): 483 missing → only 258 can be updated
- `XRRD002-2025` (ID: 113): 407 missing → only 182 can be updated

### ✅ **Already Complete Projects**
Projects showing "No updates needed" already have all their COM IDs populated.

## This Validates the Process

The dry run demonstrates that:

1. **The Excel parsing works**: It's successfully reading COM ID mappings from comlist files
2. **The matching logic works**: Document IDs from the database are being matched to barcodes in Excel
3. **The validation works**: COM IDs are being properly validated before assignment
4. **The safety works**: Existing COM IDs aren't being overwritten (no `--force` flag)

The fact that it can restore ~90% of the missing COM IDs (7,396 out of 8,201) shows the process is working very well. The ~10% that can't be matched are likely due to:
- Documents in the database that aren't in the Excel comlist
- Barcode format mismatches that the fallback logic can't resolve
- Invalid or missing entries in the Excel files

**This is exactly what you'd expect from a well-functioning COM ID restoration system!**

---

_**User (2025-10-21 07:41Z)**_

can we ignore folders with XRRD?

---

_**Agent (model claude-4-sonnet, mode Agent)**_

Yes, we can modify the command to ignore projects with XRRD in their archive_id. Looking at the output, I can see several XRRD projects that you might want to exclude.

Let me add a filter option to the command:

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **code_edit** • Edit file: micro/microapp/management/commands/restore_com_ids.py</summary>

**Chunk 1**
Lines added: 5, lines removed: undefined

```diff
@@ -136,4 +136,9 @@
              help=&#39;Show detailed output for each document processed&#39;,
          )
+         parser.add_argument(
+             &#39;--exclude-xrrd&#39;,
+             action=&#39;store_true&#39;,
+             help=&#39;Exclude projects with XRRD in their archive_id&#39;,
+         )
  
      def handle(self, *args, **options):
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **code_edit** • Edit file: micro/microapp/management/commands/restore_com_ids.py</summary>

**Chunk 1**
Lines added: 1, lines removed: undefined

```diff
@@ -147,4 +147,5 @@
          self.verbose = options[&#39;verbose&#39;]
          self.batch = options[&#39;batch&#39;]
+         self.exclude_xrrd = options[&#39;exclude_xrrd&#39;]
          
          if self.dry_run:
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **code_edit** • Edit file: micro/microapp/management/commands/restore_com_ids.py</summary>

**Chunk 1**
Lines added: 6, lines removed: undefined

```diff
@@ -166,4 +166,10 @@
              projects = Project.objects.filter(comlist_path__isnull=False).exclude(comlist_path=&#39;&#39;)
          
+         # Apply XRRD exclusion filter if requested
+         if self.exclude_xrrd:
+             projects = [p for p in projects if &#39;XRRD&#39; not in p.archive_id]
+             if self.verbose:
+                 self.stdout.write(&#39;Excluding projects with XRRD in archive_id&#39;)
+         
          if not projects:
              if self.batch:
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **code_edit** • Edit file: micro/microapp/management/commands/restore_com_ids.py</summary>

**Chunk 1**
Lines added: 4, lines removed: undefined

```diff
@@ -238,4 +238,8 @@
          
          for project in projects_with_comlist:
+             # Skip XRRD projects if exclusion is enabled
+             if self.exclude_xrrd and &#39;XRRD&#39; in project.archive_id:
+                 continue
+                 
              # Check if this project has documents without COM IDs
              documents_without_com_ids = Document.objects.filter(
```

</details>

</tool-use>

---

Now let's also update the help text to include the new option:

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **code_edit** • Edit file: micro/microapp/management/commands/restore_com_ids.py</summary>

**Chunk 1**
Lines added: 1, lines removed: undefined

```diff
@@ -10,4 +10,5 @@
      python manage.py restore_com_ids --project-id 123   # Process specific project
      python manage.py restore_com_ids --dry-run          # Show what would be updated without saving
+     python manage.py restore_com_ids --exclude-xrrd     # Exclude projects with XRRD in archive_id
  &quot;&quot;&quot;
  
```

</details>

</tool-use>

---

Perfect! Now you can use the `--exclude-xrrd` flag to ignore projects with XRRD in their archive_id. Here's how to use it:

## New Usage Options

```bash
# Dry run excluding XRRD projects
python manage.py restore_com_ids --dry-run --exclude-xrrd

# Batch mode excluding XRRD projects  
python manage.py restore_com_ids --batch --exclude-xrrd

# Process all projects excluding XRRD projects
python manage.py restore_com_ids --exclude-xrrd

# You can combine it with other flags
python manage.py restore_com_ids --dry-run --exclude-xrrd --verbose
```

## What This Does

Based on your terminal output, this will exclude these XRRD projects:
- `XRRD002-2025` (ID: 114): 483 missing COM IDs
- `XRRD002-2025` (ID: 113): 407 missing COM IDs  
- `XRRD002-2025` (ID: 112): 459 missing COM IDs
- `XRRD002-2025` (ID: 111): 455 missing COM IDs

This will reduce the scope from **8,201 missing COM IDs** down to **~6,437 missing COM IDs** (excluding the ~1,764 from XRRD projects), making the processing faster and more focused on the projects you actually want to update.

The filter works at both the project selection level and in the batch mode function, so it will consistently exclude XRRD projects regardless of which mode you use.

---

