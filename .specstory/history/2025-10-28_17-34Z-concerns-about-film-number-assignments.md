<!-- Generated by SpecStory, Markdown v2.0.0 -->

<!-- cursor Session 818890b5-160f-48e0-b703-4078e30e99fe (2025-10-28 17:34Z) -->

# Concerns about film number assignments (2025-10-28 17:34Z)

_**User (2025-10-28 15:29Z)**_

 @README.md do you see an issue with the premature filmnumber assignment and adjacent temp roll handling? especially with deviating workflows, such as refilming, rework etc.

---

_**Agent (model claude-4-sonnet, mode Agent)**_

I'll analyze the README to understand the film number assignment and temporary roll handling workflow, then examine the codebase to identify potential issues with deviating workflows like refilming and rework.

---

<tool-use data-tool-type="search" data-tool-name="codebase_search">
<details>
                <summary>Tool use: **codebase_search** • Searched codebase "How does film number allocation work and when are film numbers assigned to rolls?" • **7** results</summary>
            
| File | Lines |
|------|-------|
| `übergabe/microexcel/microfilm/models.py` | L521-627 |
| `.origin/microfilm/models.py` | L521-627 |
| `micro/microapp/views/filmnumber_views.py` | L441-740 |
| `micro/microapp/services/film_number_manager.py` | L37-1580 |
| `übergabe/microexcel/.origin/microfilm/models.py` | L521-627 |
| `übergabe/microexcel/microfilm/microfilmC/database.c` | L412-468 |
| `micro/microapp/services/film_number_manager.py` | L39-1580 |

</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="codebase_search">
<details>
                <summary>Tool use: **codebase_search** • Searched codebase "How are temporary rolls created and managed during the allocation process?" • **6** results</summary>
            
| File | Lines |
|------|-------|
| `micro/microapp/models.py` | L160-336 |
| `micro/microapp/services/sma_service.py` | L21-1336 |
| `micro/microapp/services/film_number_manager.py` | L39-1580 |
| `.origin/microfilm.py` | L2250-2594 |
| `micro/microapp/services/roll_manager.py` | L24-617 |
| `übergabe/microexcel/.origin/microfilm.py` | L2250-2594 |

</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="codebase_search">
<details>
                <summary>Tool use: **codebase_search** • Searched codebase "What happens during refilming or rework workflows and how are film numbers handled?" • **6** results</summary>
            
| File | Lines |
|------|-------|
| `micro/microapp/services/film_number_manager.py` | L39-1580 |
| `übergabe/microexcel/microfilm/models.py` | L521-627 |
| `micro/microapp/static/microapp/js/register/filmnumber/filmnumber-api.js` | L4-600 |
| `.origin/microfilm/models.py` | L521-627 |
| `micro/microapp/services/film_number_manager.py` | L37-1580 |
| `micro/staticfiles/microapp/js/register/filmnumber/filmnumber-api.js` | L4-600 |

</details>
</tool-use>

---

Now let me search for specific refilming and rework handling:

---

<tool-use data-tool-type="search" data-tool-name="codebase_search">
<details>
                <summary>Tool use: **codebase_search** • Searched codebase "How does the system handle refilming scenarios and what happens to already assigned film numbers?" • **5** results</summary>
            
| File | Lines |
|------|-------|
| `micro/microapp/services/sma_service.py` | L21-1336 |
| `übergabe/microexcel/microfilm/models.py` | L521-627 |
| `micro/microapp/services/film_number_manager.py` | L39-1580 |
| `.origin/microfilm/models.py` | L521-627 |
| `übergabe/microexcel/.origin/microfilm/models.py` | L521-627 |

</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="codebase_search">
<details>
                <summary>Tool use: **codebase_search** • Searched codebase "What happens when a project needs to be reworked or reprocessed after film numbers are assigned?" • **8** results</summary>
            
| File | Lines |
|------|-------|
| `micro/microapp/services/project_manager.py` | L16-408 |
| `micro/microapp/views/filmnumber_views.py` | L441-740 |
| `übergabe/microexcel/microfilm/analysis_main.py` | L258-470 |
| `micro/microapp/services/film_number_manager.py` | L39-1580 |
| `micro/microapp/views/index_views.py` | L354-829 |
| `.origin/microfilm.py` | L2119-2250 |
| `micro/microapp/services/film_number_manager.py` | L37-1580 |
| `micro/microapp/views/filmnumber_views.py` | L236-439 |

</details>
</tool-use>

---

<tool-use data-tool-type="grep" data-tool-name="grep">
<details>
<summary>Tool use: **grep** • Grep for "film_allocation_complete" • 74 matches</summary>

Output mode: content


| File | Content | Line |
|------|------|------|
| `.\micro\microapp\api.py` | `'film_allocation_complete': project.film_allocation_complete` | L687 |
| `.\micro\microapp\services\analyze_service.py` | `project.film_allocation_complete or` | L96 |
| `.\micro\microapp\views\distribution_views.py` | `if not project.film_allocation_complete:` | L87 |
| `.\micro\microapp\views\analyze_views.py` | `'film_allocation_complete': project.film_allocation_complete,` | L374 |
| `.\micro\microapp\views\analyze_views.py` | `elif project.film_allocation_complete:` | L810 |
| `.\micro\microapp\templates\microapp\analyze\analyze.html` | `\{% elif project.film_allocation_complete %\}` | L661 |
| `.\micro\microapp\models.py` | `film_allocation_complete = models.BooleanField(default=False)` | L56 |
| `.\micro\microapp\admin.py` | `'index_path', 'data_dir', 'film_allocation_complete', 'distribution_complete', 'handoff_complete')` | L17 |
| `.\micro\microapp\admin.py` | `list_filter = ('processing_complete', 'has_pdf_folder', 'has_oversized', 'location', 'film_allocation_complete', 'distribution_complete', 'handoff_complete')` | L19 |
| `.\micro\microapp\admin.py` | `'fields': ('has_pdf_folder', 'processing_complete', 'film_allocation_complete', 'distribution_complete', 'handoff_complete')` | L30 |
| `.\micro\micro_merge\distribution_manager.py` | `if not project.film_allocation_complete:` | L82 |
| `.\micro\micro_merge\distribution_manager.py` | `if not project.film_allocation_complete:` | L659 |
| `.\micro\staticfiles\microapp\js\register\export.js` | `if (results.film_allocation_complete) \{` | L782 |
| `.\micro\staticfiles\microapp\js\analyze\analyze.js` | `\} else if (project.film_allocation_complete) \{` | L851 |
| `.\micro\microapp\static\microapp\js\register\export.js` | `if (results.film_allocation_complete) \{` | L839 |
| `.\micro\microapp\services\film_number_manager.py` | `if project.film_allocation_complete:` | L82 |
| `.\micro\microapp\services\film_number_manager.py` | `project.film_allocation_complete = True` | L211 |
| `.\übergabe\microexcel\Excel_Reports\db analysis\microapp_project_sample.csv` | `id,archive_id,location,doc_type,project_path,project_folder_name,comlist_path,output_dir,processing_complete,retain_sources,created_at,updated_at,owner_id,add_to_database,has_oversized,total_pages,total_pages_with_refs,has_pdf_folder,pdf_folder_path,data_dir,distribution_complete,documents_with_oversized,film_allocation_complete,index_path,total_oversized,folder_path,name,handoff_complete` | L1 |
| `.\micro\microapp\services\sma_service.py` | `film_allocation_complete = getattr(project, 'film_allocation_complete', False)` | L835 |
| `.\micro\microapp\services\sma_service.py` | `if film_allocation_complete:` | L836 |
| `.\micro\microapp\services\sma_service.py` | `'film_allocation_complete': film_allocation_complete` | L854 |
| `.\micro\microapp\static\microapp\js\analyze\analyze.js` | `\} else if (project.film_allocation_complete) \{` | L851 |
| `.\micro\staticfiles\microapp\js\register\filmnumber\filmnumber-api.js` | `film_allocation_complete: serverResponse.film_allocation_complete,` | L434 |
| `.\micro\staticfiles\microapp\js\register\filmnumber_old\api.js` | `film_allocation_complete: true,` | L232 |
| `.\micro\staticfiles\microapp\js\register\filmnumber_old\filmnumber_old.js` | `film_allocation_complete: true,` | L450 |
| `.\micro\staticfiles\microapp\js\explore\models\roll\roll-details.js` | `\} else if (project.film_allocation_complete) \{` | L364 |
| `.\micro\staticfiles\microapp\js\explore\models\project\project-list.js` | `filters.film_allocation_complete = 'false';` | L318 |
| `.\micro\staticfiles\microapp\js\explore\models\project\project-list.js` | `filters.film_allocation_complete = 'true';` | L323 |
| `.\micro\staticfiles\microapp\js\explore\models\project\project-list.js` | `\} else if (project.film_allocation_complete) \{` | L498 |
| `.\micro\staticfiles\microapp\js\explore\models\project\project-list.js` | `<td><span class="boolean-badge $\{project.film_allocation_complete ? 'true' : 'false'\}">$\{project.film_allocation_complete ? 'Yes' : 'No'\}</span></td>` | L538 |
| `.\micro\staticfiles\microapp\js\explore\models\project\project-list.js` | `\} else if (project.film_allocation_complete) \{` | L940 |
| `.\micro\staticfiles\microapp\js\explore\models\project\project-export.js` | `<input type="checkbox" name="export-fields" value="film_allocation_complete" checked>` | L159 |
| `.\micro\staticfiles\microapp\js\explore\models\project\project-export.js` | `'film_allocation_complete': 'Film Allocation Complete',` | L749 |
| `.\micro\staticfiles\microapp\js\explore\models\project\project-details.js` | `\} else if (project.film_allocation_complete) \{` | L153 |
| `.\micro\staticfiles\microapp\js\explore\models\project\project-details.js` | `<td>$\{project.film_allocation_complete ? 'Yes' : 'No'\}</td>` | L241 |
| `.\micro\staticfiles\microapp\js\explore\models\document\document-details.js` | `\} else if (project.film_allocation_complete) \{` | L321 |
| `.\micro\staticfiles\microapp\js\explore\explore_details.js` | `\} else if (item.film_allocation_complete) \{` | L36 |
| `.\micro\staticfiles\microapp\js\explore\explore_details.js` | `<span class="detail-value">$\{item.film_allocation_complete ? 'Yes' : 'No'\}</span>` | L110 |
| `.\micro\staticfiles\microapp\js\explore\explore.js` | `\} else if (item.film_allocation_complete) \{` | L471 |
| `.\micro\staticfiles\microapp\js\explore\explore.js` | `\} else if (item.film_allocation_complete) \{` | L578 |
| `.\micro\staticfiles\microapp\js\explore\explore-main.js` | `\{ value: 'film_allocation_complete', label: 'Film Allocation Complete' \},` | L60 |
| `.\micro\microapp\views\sma_views.py` | `'film_allocation_complete': getattr(project, 'film_allocation_complete', None)` | L1094 |
| `.\micro\microapp\static\microapp\js\register\filmnumber\filmnumber-api.js` | `film_allocation_complete: serverResponse.film_allocation_complete,` | L434 |
| `.\micro\microapp\views\filmnumber_views.py` | `context['allocation_complete'] = project.film_allocation_complete` | L124 |
| `.\micro\microapp\views\filmnumber_views.py` | `if not project.film_allocation_complete:` | L253 |
| `.\micro\microapp\views\filmnumber_views.py` | `"film_allocation_complete": project.film_allocation_complete,` | L715 |
| `.\micro\microapp\views\project_views.py` | `'film_allocation_complete': 'film_allocation_complete',` | L152 |
| `.\micro\microapp\views\project_views.py` | `'film_allocation_complete': project.film_allocation_complete,` | L198 |
| `.\micro\microapp\views\project_views.py` | `'film_allocation_complete': project.film_allocation_complete,` | L256 |
| `.\micro\microapp\views\project_views.py` | `["Film Allocation Complete", sum(1 for p in projects if p.get('film_allocation_complete'))],` | L790 |
| `.\micro\microapp\templates\microapp\explore\project\project-content.html` | `<th class="sortable" data-sort="film_allocation_complete">` | L81 |
| `.\micro\microapp\static\microapp\js\explore\models\roll\roll-details.js` | `\} else if (project.film_allocation_complete) \{` | L364 |
| `.\micro\microapp\static\microapp\js\explore\models\project\project-list.js` | `filters.film_allocation_complete = 'false';` | L318 |
| `.\micro\microapp\static\microapp\js\explore\models\project\project-list.js` | `filters.film_allocation_complete = 'true';` | L323 |
| `.\micro\microapp\static\microapp\js\explore\models\project\project-list.js` | `\} else if (project.film_allocation_complete) \{` | L498 |
| `.\micro\microapp\static\microapp\js\explore\models\project\project-list.js` | `<td><span class="boolean-badge $\{project.film_allocation_complete ? 'true' : 'false'\}">$\{project.film_allocation_complete ? 'Yes' : 'No'\}</span></td>` | L538 |
| `.\micro\microapp\static\microapp\js\explore\models\project\project-list.js` | `\} else if (project.film_allocation_complete) \{` | L940 |
| `.\micro\microapp\static\microapp\js\explore\models\project\project-details.js` | `\} else if (project.film_allocation_complete) \{` | L153 |
| `.\micro\microapp\static\microapp\js\explore\models\project\project-details.js` | `<td>$\{project.film_allocation_complete ? 'Yes' : 'No'\}</td>` | L241 |
| `.\micro\microapp\static\microapp\js\explore\models\project\project-export.js` | `<input type="checkbox" name="export-fields" value="film_allocation_complete" checked>` | L159 |
| `.\micro\microapp\static\microapp\js\explore\models\project\project-export.js` | `'film_allocation_complete': 'Film Allocation Complete',` | L749 |
| `.\micro\microapp\static\microapp\js\explore\models\document\document-details.js` | `\} else if (project.film_allocation_complete) \{` | L321 |
| `.\micro\microapp\static\microapp\js\explore\explore_details.js` | `\} else if (item.film_allocation_complete) \{` | L36 |
| `.\micro\microapp\static\microapp\js\explore\explore_details.js` | `<span class="detail-value">$\{item.film_allocation_complete ? 'Yes' : 'No'\}</span>` | L110 |
| `.\micro\microapp\static\microapp\js\explore\explore.js` | `\} else if (item.film_allocation_complete) \{` | L471 |
| `.\micro\microapp\static\microapp\js\explore\explore.js` | `\} else if (item.film_allocation_complete) \{` | L578 |
| `.\micro\microapp\static\microapp\js\explore\explore-main.js` | `\{ value: 'film_allocation_complete', label: 'Film Allocation Complete' \},` | L60 |
| `.\micro\microapp\services\project_manager.py` | `"film_allocation_complete": project.film_allocation_complete,` | L311 |
| `.\micro\microapp\services\project_manager.py` | `"film_allocation_complete": project.film_allocation_complete` | L348 |
| `.\micro\microapp\services\distribution_manager.py` | `if not project.film_allocation_complete:` | L82 |
| `.\micro\microapp\services\distribution_manager.py` | `if not project.film_allocation_complete:` | L723 |
| `.\micro\microapp\static\microapp\js\register\filmnumber_old\filmnumber_old.js` | `film_allocation_complete: true,` | L450 |
| `.\micro\microapp\static\microapp\js\register\filmnumber_old\api.js` | `film_allocation_complete: true,` | L232 |
| `.\micro\microapp\migrations\0005_project_data_dir_project_distribution_complete_and_more.py` | `name='film_allocation_complete',` | L31 |


</details>
</tool-use>

---

Now let me examine the specific workflow and timing issues:

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: micro/microapp/services/film_number_manager.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="codebase_search">
<details>
                <summary>Tool use: **codebase_search** • Searched codebase "What happens if a project needs to be reprocessed or refilmed after film numbers are already assigned?" • **6** results</summary>
            
| File | Lines |
|------|-------|
| `micro/microapp/services/project_manager.py` | L16-408 |
| `micro/microapp/services/film_number_manager.py` | L39-1580 |
| `micro/microapp/services/film_number_manager.py` | L37-1580 |
| `übergabe/microexcel/microfilm/analysis_main.py` | L258-470 |
| `.origin/microfilm.py` | L2119-2250 |
| `micro/microapp/views/filmnumber_views.py` | L441-740 |

</details>
</tool-use>

---

Based on my analysis of the codebase and the README, I can identify several significant issues with the premature film number assignment and temporary roll handling, especially regarding deviating workflows like refilming and rework:

## Critical Issues Identified

### 1. **Premature Film Number Assignment**

The system assigns film numbers **too early** in the Register phase (step 5 in the README), before actual filming occurs. This creates several problems:

```82:84:micro/microapp/services/film_number_manager.py
                if project.film_allocation_complete:
                    self.logger.info(f"Film allocation already complete for project {project.archive_id}, skipping")
                    return project, None
```

**Problems:**
- **Film numbers are consumed from the database sequence** before physical filming
- **No rollback mechanism** if filming fails or needs rework
- **Film number gaps** occur when projects are abandoned after allocation
- **Reprocessing is blocked** by the `film_allocation_complete` flag

### 2. **Rigid Completion Flag**

The `film_allocation_complete` flag acts as a **one-way gate** that prevents reprocessing:

```210:212:micro/microapp/services/film_number_manager.py
                # Mark film allocation as complete
                project.film_allocation_complete = True
                project.save()
```

**Issues:**
- **No mechanism to reset** the flag for legitimate rework scenarios
- **Blocks refilming** operations that need new film number allocation
- **Forces manual database intervention** for workflow deviations

### 3. **Temporary Roll Management Problems**

The temporary roll system has timing and lifecycle issues:

```2542:2570:.origin/microfilm.py
                # If this roll is partial and has enough remaining capacity, create a temp roll
                if is_partial and temp_roll_id is None and roll_data.get("partialRollInfo"):
                    usable_capacity = roll_data["partialRollInfo"].get("usableCapacity", 0)
                    
                    if usable_capacity >= TEMP_ROLL_MIN_USABLE_PAGES:
                        # Create a temp roll
                        cursor.execute(
                            "INSERT INTO TempRolls (film_type, capacity, usable_capacity, status, creation_date, source_roll_id, chain_film_number) VALUES (?, ?, ?, ?, ?, ?, ?)",
                            (
                                "16mm",
                                roll_data["partialRollInfo"].get("remainingCapacity", 0),
                                usable_capacity,
                                "available",
                                datetime.now().isoformat(),
                                roll_db_id,
                                film_number  # Set the chain_film_number to continue with this film number
                            )
                        )
```

**Problems:**
- **Temp rolls are created before physical filming** completes
- **Film numbers are pre-assigned** to temp rolls that may never be used
- **No cleanup mechanism** for unused temp rolls from failed projects

### 4. **Refilming Workflow Issues**

The refilming logic attempts to work around the rigid system but has limitations:

```1007:1025:micro/microapp/services/sma_service.py
    def _handle_refilming_temp_roll_creation(cls, roll) -> bool:
        """Handle temp roll allocation for re-filming operations using temp roll strategy."""
        try:
            from ..models import TempRoll
            
            roll_display = roll.roll_number or roll.film_number or f"Roll {roll.id}"
            pages_needed = roll.pages_used  # Use pages_used as the filming requirement
            
            logger.info(f"Re-filming {roll_display}: need to film {pages_needed} pages")
            
            # Step 1: Check for available temp rolls that physically exist and can handle the pages needed
            available_temp_rolls = TempRoll.objects.filter(
                film_type=roll.film_type,
                status='available',
                exists=True,
                usable_capacity__gte=pages_needed
            ).order_by('usable_capacity')
            
            if available_temp_rolls.exists():
```

**Issues:**
- **Depends on existing temp rolls** which may not be available
- **Cannot allocate new film numbers** due to completion flag
- **Limited to temp roll capacity** constraints

## Recommended Solutions

### 1. **Defer Film Number Assignment**
Move film number allocation to **after successful filming** rather than during Register phase:
- Assign temporary IDs during Register
- Allocate actual film numbers only after SMA confirms successful filming
- Implement rollback for failed filming attempts

### 2. **Implement Workflow State Management**
Replace the binary `film_allocation_complete` flag with a more nuanced state system:
- `register_complete`
- `filming_in_progress` 
- `filming_complete`
- `rework_required`
- `archived`

### 3. **Lazy Temp Roll Creation**
Create temp rolls only **after** physical filming completes:
- Calculate temp roll potential during Register
- Create actual temp rolls in Film phase post-completion
- Clean up unused temp roll allocations

### 4. **Add Reprocessing Support**
Implement proper reprocessing workflows:
- Reset project state for legitimate rework
- Preserve film number history for audit trails
- Support partial reprocessing (specific rolls)

This architectural change would make the system much more resilient to real-world workflow deviations while preventing film number waste and database inconsistencies.

---

